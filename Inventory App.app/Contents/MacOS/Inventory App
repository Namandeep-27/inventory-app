#!/bin/bash

# Get the project directory (same directory as the app bundle)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
APP_BUNDLE_DIR="$( cd "$SCRIPT_DIR/../.." && pwd )"
PROJECT_DIR="$( cd "$APP_BUNDLE_DIR/.." && pwd )"

# Terminal colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}==========================================${NC}"
echo -e "${GREEN}   Starting Inventory System${NC}"
echo -e "${GREEN}==========================================${NC}"
echo ""

# Check if backend directory exists
if [ ! -d "$PROJECT_DIR/backend" ]; then
    echo -e "${RED}❌ Error: backend directory not found!${NC}"
    echo "Expected: $PROJECT_DIR/backend"
    echo ""
    echo "Please make sure 'Inventory App.app' is in the same folder as 'backend' and 'frontend'"
    read -p "Press Enter to exit..."
    exit 1
fi

# Start backend
echo -e "${YELLOW}Starting backend server...${NC}"
cd "$PROJECT_DIR/backend"

if [ ! -f "venv/bin/activate" ]; then
    echo -e "${RED}❌ Error: Virtual environment not found!${NC}"
    echo "Please run: cd backend && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt"
    read -p "Press Enter to exit..."
    exit 1
fi

source venv/bin/activate
uvicorn app.main:app --port 8000 > /tmp/inventory-backend.log 2>&1 &
BACKEND_PID=$!

# Wait for backend
echo "Waiting for backend to start..."
sleep 3

# Check if backend is running
if ! curl -s http://localhost:8000/health > /dev/null 2>&1; then
    echo -e "${RED}⚠️  Backend may not have started yet... continuing${NC}"
    sleep 2
fi

if curl -s http://localhost:8000/health > /dev/null 2>&1; then
    echo -e "${GREEN}✅ Backend started successfully${NC}"
else
    echo -e "${YELLOW}⚠️  Backend may still be starting... continuing anyway${NC}"
fi

# Start frontend
echo -e "${YELLOW}Starting frontend server...${NC}"
cd "$PROJECT_DIR/frontend"

if [ ! -f "package.json" ]; then
    echo -e "${RED}❌ Error: Frontend not found!${NC}"
    echo "Expected: $PROJECT_DIR/frontend"
    kill $BACKEND_PID 2>/dev/null
    read -p "Press Enter to exit..."
    exit 1
fi

npm run dev > /tmp/inventory-frontend.log 2>&1 &
FRONTEND_PID=$!

# Wait for frontend
echo "Waiting for frontend to start..."
sleep 5

echo -e "${GREEN}✅ Frontend started${NC}"
echo ""
echo -e "${GREEN}Opening browser...${NC}"
open http://localhost:3000

echo ""
echo -e "${GREEN}==========================================${NC}"
echo -e "${GREEN}   Inventory System is Running!${NC}"
echo -e "${GREEN}==========================================${NC}"
echo ""
echo "Frontend: http://localhost:3000"
echo "Backend:  http://localhost:8000"
echo "API Docs: http://localhost:8000/docs"
echo ""
echo -e "${YELLOW}To stop servers:${NC} Close this window or press Ctrl+C"
echo ""

# Function to cleanup on exit
cleanup() {
    echo ""
    echo -e "${YELLOW}Stopping servers...${NC}"
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    echo -e "${GREEN}✅ Servers stopped${NC}"
    exit 0
}

trap cleanup SIGINT SIGTERM

# Wait for user interrupt
wait $BACKEND_PID $FRONTEND_PID 2>/dev/null || true
